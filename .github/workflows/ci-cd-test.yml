name: ğŸ§ª Test Environment CI/CD Pipeline

# ========== íŠ¸ë¦¬ê±° ì¡°ê±´ ìµœì í™” ==========
on:
  # ìë™ íŠ¸ë¦¬ê±° (develop_deploy_pipeline ë¸Œëœì¹˜) 
  push:
    branches: [develop_deploy_pipeline]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

  # PR íŠ¸ë¦¬ê±° (develop_deploy_pipelineë¡œì˜ PR)
  pull_request:
    branches: [develop_deploy_pipeline]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

  # ìˆ˜ë™ ì‹¤í–‰ (ê³ ê¸‰ ì˜µì…˜ í¬í•¨)
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'ğŸ Deploy Backend to Test'
        type: boolean
        default: true
      deploy_frontend:
        description: 'ğŸ¨ Deploy Frontend to Test'
        type: boolean
        default: true
      skip_tests:
        description: 'âš¡ Skip Quality Gate (Emergency Only)'
        type: boolean
        default: false
      debug_mode:
        description: 'ğŸ” Enable Debug Logging'
        type: boolean
        default: false
      force_rebuild:
        description: 'ğŸ”„ Force Rebuild Images (No Cache)'
        type: boolean
        default: false

  # ìŠ¤ì¼€ì¤„ë§ íŠ¸ë¦¬ê±° (ì„ íƒì  - ì•¼ê°„ ë¹Œë“œ)
  schedule:
    - cron: '0 2 * * 1-5'  # í‰ì¼ ì˜¤ì „ 2ì‹œ (UTC, KST 11ì‹œì— í•´ë‹¹)  # 2 AM UTC (which is 11 AM KST on weekdays)

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  BACKEND_APP_NAME_TEST: "7ai-team1-backend-test"
  AZURE_RESOURCE_GROUP_TEST: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  # ========== íŠ¸ë¦¬ê±° ì¡°ê±´ ì²´í¬ (ìˆ˜ì •ë¨) ==========
  trigger-validation:
    runs-on: ubuntu-latest
    name: ğŸ” Validate Trigger Conditions
    outputs:
      should_deploy_backend: ${{ steps.conditions.outputs.should_deploy_backend }}
      should_deploy_frontend: ${{ steps.conditions.outputs.should_deploy_frontend }}
      deployment_reason: ${{ steps.conditions.outputs.deployment_reason }}

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # ë³€ê²½ì‚¬í•­ ë¹„êµë¥¼ ìœ„í•´ ì´ì „ ì»¤ë°‹ë„ ê°€ì ¸ì˜´

    - name: ğŸ” Analyze Trigger Conditions (Enhanced)
      id: conditions
      run: |
        echo "ğŸ” Analyzing trigger conditions..."
        
        # íŠ¸ë¦¬ê±° ì›ì¸ ë¶„ì„
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          REASON="Manual execution by ${{ github.actor }}"
          BACKEND_DEPLOY="${{ github.event.inputs.deploy_backend }}"
          FRONTEND_DEPLOY="${{ github.event.inputs.deploy_frontend }}"
          echo "ğŸ”§ Manual trigger detected"
        elif [ "${{ github.event_name }}" = "schedule" ]; then
          REASON="Scheduled nightly build"
          BACKEND_DEPLOY="true"
          FRONTEND_DEPLOY="true"
          echo "â° Scheduled trigger detected"
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          REASON="Pull request validation"
          BACKEND_DEPLOY="false"  # PRì—ì„œëŠ” ë°°í¬í•˜ì§€ ì•ŠìŒ
          FRONTEND_DEPLOY="false"
          echo "ğŸ” PR trigger detected - validation only"
        else
          REASON="Code push to develop_deploy_pipeline"
          echo "ğŸ“ Push trigger detected - analyzing changed files..."
          
          # ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
          git diff --name-only HEAD~ HEAD > changed_files.txt || echo "No previous commit to compare"
          
          echo "ğŸ“‹ Changed files:"
          cat changed_files.txt
          echo "================================"
          
          # ê¸°ë³¸ê°’ ì„¤ì •
          BACKEND_DEPLOY="false"
          FRONTEND_DEPLOY="false"
          
          # ë°±ì—”ë“œ ê´€ë ¨ ë³€ê²½ ê°ì§€
          if grep -E "^backend_py/" changed_files.txt >/dev/null 2>&1; then
            echo "ğŸ Backend code changes detected"
            BACKEND_DEPLOY="true"
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨ ë³€ê²½ ê°ì§€
          if grep -E "^frontend/" changed_files.txt >/dev/null 2>&1; then
            echo "ğŸ¨ Frontend code changes detected"
            FRONTEND_DEPLOY="true"
          fi
          
          # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ ê°ì§€ (ì¤‘ìš”!)
          if grep -E "^\.github/workflows/" changed_files.txt >/dev/null 2>&1; then
            echo "ğŸ”§ GitHub Actions workflow changes detected - deploying all services"
            BACKEND_DEPLOY="true"
            FRONTEND_DEPLOY="true"
          fi
          
          # ì¸í”„ë¼/ì„¤ì • íŒŒì¼ ë³€ê²½ ê°ì§€ (í™•ì¥ë¨)
          if grep -E "(docker-compose|Dockerfile|package\.json|requirements\.txt|\.env|env-.*\.sh|validate-.*\.sh)" changed_files.txt >/dev/null 2>&1; then
            echo "ğŸ“¦ Infrastructure/Config changes detected - deploying all services"
            BACKEND_DEPLOY="true"
            FRONTEND_DEPLOY="true"
          fi
          
          # ë£¨íŠ¸ ë ˆë²¨ ì„¤ì • íŒŒì¼ ë³€ê²½ ê°ì§€
          if grep -E "^(tsconfig|vite\.config|tailwind\.config|postcss\.config|eslint|\.gitignore)" changed_files.txt >/dev/null 2>&1; then
            echo "âš™ï¸ Root config changes detected - deploying frontend"
            FRONTEND_DEPLOY="true"
          fi
          
          # docs, README ë“±ì€ ë°°í¬í•˜ì§€ ì•ŠìŒ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
          if ! grep -E "\.(md|txt|yml|yaml)$" changed_files.txt | grep -v -E "(package\.json|requirements\.txt|docker-compose|workflows)" >/dev/null 2>&1; then
            echo "ğŸ“ Only documentation changes detected - no deployment needed"
          fi
          
          # ê°•ì œ ë°°í¬ ì¡°ê±´ (ì²« ë²ˆì§¸ ì»¤ë°‹ì´ë‚˜ ë¸Œëœì¹˜ ìƒì„± ì‹œ)
          if [ ! -s changed_files.txt ]; then
            echo "ğŸš€ No previous commit found - this might be first commit or new branch"
            echo "ğŸš€ Forcing full deployment for safety"
            BACKEND_DEPLOY="true"
            FRONTEND_DEPLOY="true"
            REASON="First commit or new branch - full deployment"
          fi
        fi
        
        echo "should_deploy_backend=${BACKEND_DEPLOY}" >> $GITHUB_OUTPUT
        echo "should_deploy_frontend=${FRONTEND_DEPLOY}" >> $GITHUB_OUTPUT
        echo "deployment_reason=${REASON}" >> $GITHUB_OUTPUT
        
        echo "================================"
        echo "ğŸ“‹ Final Deployment Decision:"
        echo "- Reason: ${REASON}"
        echo "- Deploy Backend: ${BACKEND_DEPLOY}"
        echo "- Deploy Frontend: ${FRONTEND_DEPLOY}"
        echo "- Event: ${{ github.event_name }}"
        echo "- Actor: ${{ github.actor }}"
        echo "================================"

  # ========== í’ˆì§ˆ ê²Œì´íŠ¸ ==========
  quality-gate:
    if: github.event.inputs.skip_tests != 'true' && github.event_name != 'pull_request'
    needs: trigger-validation
    runs-on: ubuntu-latest
    name: ğŸ” Quality Gate

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ Setup Python (No Pip Cache)
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ”§ Frontend Quality Check
      if: needs.trigger-validation.outputs.should_deploy_frontend == 'true' || github.event_name == 'schedule'
      run: |
        cd frontend
        echo "ğŸ” Installing frontend dependencies..."
        npm ci --legacy-peer-deps || {
          echo "âš ï¸ npm ci failed, falling back to npm install"
          rm -f package-lock.json
          npm install --include=dev
        }
        
        echo "ğŸ” Installing cross-env (Windows/Linux compatibility)..."
        npm install --save-dev cross-env || true
        
        echo "ğŸ” TypeScript check (lenient for Test environment)..."
        npx tsc --noEmit --skipLibCheck --exclude "**/test/**" --exclude "**/*.test.*" || {
          echo "âš ï¸ TypeScript warnings exist but continuing for Test environment"
        }
        
        echo "ğŸ” Build test..."
        rm -rf dist/
        VITE_API_URL=${{ secrets.TEST_BACKEND_URL }} npx vite build --mode test
        
        echo "âœ… Frontend quality check passed"

    - name: ğŸ”§ Backend Quality Check
      if: needs.trigger-validation.outputs.should_deploy_backend == 'true' || github.event_name == 'schedule'
      run: |
        cd backend_py
        echo "ğŸ” Installing Python dependencies (no cache)..."
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        
        echo "ğŸ” Python syntax check..."
        python -m py_compile app/main.py
        
        echo "ğŸ” FastAPI import test..."
        python -c "from app.main import app; print('âœ… FastAPI app imports successfully')"
        
        echo "âœ… Backend quality check passed"

  # ========== PR ì „ìš© ê²€ì¦ ==========
  pr-validation:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: ğŸ” PR Validation (No Deployment)

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ” PR Code Validation
      run: |
        echo "ğŸ” Pull Request validation started..."
        
        # Frontend ê²€ì¦
        if [ -d "frontend" ]; then
          cd frontend
          npm ci --legacy-peer-deps || npm install --include=dev
          npx tsc --noEmit --skipLibCheck || echo "âš ï¸ TypeScript warnings found"
          npm run build || echo "âš ï¸ Build warnings found"
          cd ..
        fi
        
        # Backend ê²€ì¦  
        if [ -d "backend_py" ]; then
          cd backend_py
          pip install --no-cache-dir -r requirements.txt
          python -m py_compile app/main.py
          python -c "from app.main import app; print('âœ… FastAPI validates')"
          cd ..
        fi
        
        echo "âœ… PR validation completed - no deployment performed"

  # ========== ë°±ì—”ë“œ ë¹Œë“œ & ë°°í¬ ==========
  deploy-backend:
    if: |
      github.event_name != 'pull_request' && 
      (needs.trigger-validation.outputs.should_deploy_backend == 'true' || 
       github.event.inputs.deploy_backend == 'true' ||
       github.event_name == 'schedule')
    needs: [trigger-validation, quality-gate]
    runs-on: ubuntu-latest
    name: ğŸ Deploy Backend to Test
    environment: test
    outputs:
      deployment_status: ${{ steps.deployment.outputs.status }}

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Debug Deployment Context
      if: github.event.inputs.debug_mode == 'true'
      run: |
        echo "=== Deployment Context Debug ==="
        echo "Event: ${{ github.event_name }}"
        echo "Actor: ${{ github.actor }}"
        echo "Reason: ${{ needs.trigger-validation.outputs.deployment_reason }}"
        echo "Force Rebuild: ${{ github.event.inputs.force_rebuild }}"
        echo "App Service: ${{ env.BACKEND_APP_NAME_TEST }}"
        echo "Resource Group: ${{ env.AZURE_RESOURCE_GROUP_TEST }}"
        echo "================================"

    - name: ğŸ” Login to Azure
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: ğŸ” Verify Permissions and Resources
      run: |
        echo "ğŸ” Verifying Azure authentication and permissions..."
        az account show --query "{SubscriptionId:id, TenantId:tenantId, User:user.name}"
        
        echo "ğŸ” Checking App Service access..."
        az webapp show --name "${{ env.BACKEND_APP_NAME_TEST }}" --resource-group "${{ env.AZURE_RESOURCE_GROUP_TEST }}" --query "{Name:name, State:state}" || {
          echo "âŒ Cannot access App Service - check permissions and resource existence"
          exit 1
        }

    - name: ğŸ” Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: ğŸ—ï¸ Build and Push Backend Image
      id: build
      run: |
        cd backend_py
        echo "ğŸ—ï¸ Building backend Docker image for Test environment..."
        
        # ìºì‹œ ì „ëµ ê²°ì •
        if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
          echo "ğŸ”„ Force rebuild requested - using --no-cache"
          CACHE_OPTION="--no-cache"
        else
          echo "ğŸ“¦ Using build cache for faster builds"
          CACHE_OPTION=""
        fi
        
        docker build \
          ${CACHE_OPTION} \
          --platform linux/amd64 \
          --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
          --build-arg VCS_REF=${{ github.sha }} \
          --build-arg TRIGGER_REASON="${{ needs.trigger-validation.outputs.deployment_reason }}" \
          -t ${{ env.REGISTRY }}/backend-fastapi-test:latest \
          -t ${{ env.REGISTRY }}/backend-fastapi-test:${{ github.sha }} \
          -f Dockerfile .
        
        echo "ğŸ“¤ Pushing images to ACR..."
        docker push ${{ env.REGISTRY }}/backend-fastapi-test:latest
        docker push ${{ env.REGISTRY }}/backend-fastapi-test:${{ github.sha }}
        
        echo "âœ… Backend image build and push completed"

    - name: ğŸš€ Deploy to Azure App Service (Test)
      id: deployment
      run: |
        echo "ğŸš€ Deploying container to Test App Service..."
        
        az webapp config container set \
          --name "${{ env.BACKEND_APP_NAME_TEST }}" \
          --resource-group "${{ env.AZURE_RESOURCE_GROUP_TEST }}" \
          --docker-custom-image-name "${{ env.REGISTRY }}/backend-fastapi-test:latest" \
          --docker-registry-server-url "https://${{ env.REGISTRY }}" \
          --docker-registry-server-user "${{ secrets.ACR_USERNAME }}" \
          --docker-registry-server-password "${{ secrets.ACR_PASSWORD }}"
        
        echo "âœ… Test container deployment completed"
        echo "status=success" >> $GITHUB_OUTPUT

    - name: âš™ï¸ Configure Test Environment Variables
      run: |
        echo "âš™ï¸ Configuring Test App Service environment variables..."
        
        az webapp config appsettings set \
          --name "${{ env.BACKEND_APP_NAME_TEST }}" \
          --resource-group "${{ env.AZURE_RESOURCE_GROUP_TEST }}" \
          --settings \
            PORT=3001 \
            HOST=0.0.0.0 \
            NODE_ENV=test \
            FRONTEND_URL="${{ secrets.TEST_FRONTEND_URL }}" \
            GEMINI_API_KEY="${{ secrets.TEST_GEMINI_API_KEY }}" \
            AZURE_OPENAI_ENDPOINT="${{ secrets.TEST_AZURE_OPENAI_ENDPOINT }}" \
            AZURE_OPENAI_KEY="${{ secrets.TEST_AZURE_OPENAI_KEY }}" \
            AZURE_OPENAI_DEPLOYMENT_ID="${{ secrets.TEST_AZURE_OPENAI_DEPLOYMENT_ID }}" \
            AZURE_OPENAI_API_VERSION="2024-02-15-preview" \
            WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
            DOCKER_ENABLE_CI=true \
            DEPLOYMENT_TRIGGER="${{ needs.trigger-validation.outputs.deployment_reason }}" \
            DEPLOYMENT_COMMIT="${{ github.sha }}" \
            DEPLOYMENT_TIME="$(date -u)"
        
        echo "âœ… Test environment variables configured"

  # ========== í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ & ë°°í¬ ==========
  deploy-frontend:
    if: |
      github.event_name != 'pull_request' && 
      (needs.trigger-validation.outputs.should_deploy_frontend == 'true' || 
       github.event.inputs.deploy_frontend == 'true' ||
       github.event_name == 'schedule')
    needs: [trigger-validation, quality-gate]
    runs-on: ubuntu-latest
    name: ğŸ¨ Deploy Frontend to Test
    environment: test

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js with Cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ”§ Install and Build Frontend (Test)
      run: |
        cd frontend
        echo "ğŸ“¦ Installing dependencies with fallback strategy..."
        
        npm ci --legacy-peer-deps || {
          echo "âš ï¸ npm ci failed, using fallback strategy"
          rm -f package-lock.json
          npm install --include=dev
        }
        
        echo "ğŸ”§ Installing cross-env for cross-platform compatibility..."
        npm install --save-dev cross-env || true
        
        echo "ğŸ” TypeScript validation (lenient for Test)..."
        npx tsc --noEmit --skipLibCheck --exclude "**/test/**" --exclude "**/*.test.*" || {
          echo "âš ï¸ TypeScript warnings exist but continuing"
        }
        
        echo "ğŸ—ï¸ Building for Test environment..."
        rm -rf dist/
        
        export VITE_API_URL="${{ secrets.TEST_BACKEND_URL }}"
        export VITE_NODE_ENV="test"
        export VITE_DEV_MODE="false"
        export VITE_DEPLOYMENT_TRIGGER="${{ needs.trigger-validation.outputs.deployment_reason }}"
        export VITE_DEPLOYMENT_COMMIT="${{ github.sha }}"
        
        npx vite build --mode test
        
        echo "ğŸ“‹ Build verification..."
        ls -la dist/
        echo "Build size: $(du -sh dist/ | cut -f1)"
        echo "âœ… Frontend build completed successfully"

    - name: ğŸš€ Deploy to Azure Static Web Apps (Test)
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "frontend/dist"
        skip_app_build: true
        production_branch: "develop_deploy_pipeline"

  # ========== í—¬ìŠ¤ì²´í¬ & í†µí•© í…ŒìŠ¤íŠ¸ ==========
  health-check:
    needs: [trigger-validation, deploy-backend, deploy-frontend]
    if: always() && (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')
    runs-on: ubuntu-latest
    name: ğŸ¥ Health Check & Integration Tests

    steps:
    - name: ğŸ¥ Backend Health Check
      if: needs.deploy-backend.result == 'success'
      run: |
        echo "ğŸ” Waiting for Test App Service to initialize..."
        sleep 90
        
        echo "ğŸ” Test backend health check..."
        BACKEND_URL="${{ secrets.TEST_BACKEND_URL }}"
        
        for i in {1..12}; do
          echo "ğŸ“¡ Health check attempt $i/12..."
          
          if curl -f -s --max-time 30 "${BACKEND_URL}/health"; then
            echo "âœ… Test backend is healthy!"
            echo "BACKEND_HEALTH=success" >> $GITHUB_ENV
            break
          elif [ $i -eq 12 ]; then
            echo "âŒ Test backend health check failed after 12 attempts"
            echo "BACKEND_HEALTH=failed" >> $GITHUB_ENV
            exit 1
          else
            echo "â³ Attempt $i failed, retrying in 30s..."
            sleep 30
          fi
        done

    - name: ğŸ¥ Frontend Health Check
      if: needs.deploy-frontend.result == 'success'
      run: |
        echo "ğŸ” Test frontend health check..."
        FRONTEND_URL="${{ secrets.TEST_FRONTEND_URL }}"
        
        for i in {1..8}; do
          if curl -f -s --max-time 30 "${FRONTEND_URL}"; then
            echo "âœ… Test frontend is healthy!"
            echo "FRONTEND_HEALTH=success" >> $GITHUB_ENV
            break
          elif [ $i -eq 8 ]; then
            echo "âŒ Test frontend health check failed"
            echo "FRONTEND_HEALTH=failed" >> $GITHUB_ENV
            exit 1
          else
            echo "â³ Frontend attempt $i failed, retrying in 15s..."
            sleep 15
          fi
        done

    - name: ğŸ§ª Integration Tests
      if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
      run: |
        echo "ğŸ§ª Running integration tests..."
        
        BACKEND_URL="${{ secrets.TEST_BACKEND_URL }}"
        FRONTEND_URL="${{ secrets.TEST_FRONTEND_URL }}"
        
        echo "ğŸ” Testing API endpoints..."
        curl -f -s "${BACKEND_URL}/api" && echo "âœ… API info endpoint working"
        curl -f -s "${BACKEND_URL}/health" && echo "âœ… Health endpoint working"
        
        echo "ğŸ” Testing CORS configuration..."
        curl -H "Origin: ${FRONTEND_URL}" \
             -H "Access-Control-Request-Method: POST" \
             -H "Access-Control-Request-Headers: Content-Type" \
             -X OPTIONS "${BACKEND_URL}/api/generate" && echo "âœ… CORS working"
        
        echo "âœ… Integration tests completed successfully"

    - name: ğŸ“Š Test Deployment Summary
      run: |
        echo "## ğŸ§ª Test Environment Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Trigger** | ${{ needs.trigger-validation.outputs.deployment_reason }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Backend Status** | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Frontend Status** | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Backend Health** | ${{ env.BACKEND_HEALTH }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Frontend Health** | ${{ env.FRONTEND_HEALTH }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Backend URL** | ${{ secrets.TEST_BACKEND_URL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Frontend URL** | ${{ secrets.TEST_FRONTEND_URL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Actor** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ¯ **Test Environment Deployment Completed!**" >> $GITHUB_STEP_SUMMARY

  # ========== ìë™ ë¡¤ë°± ==========
  auto-rollback:
    needs: health-check
    if: failure()
    runs-on: ubuntu-latest
    name: ğŸ”„ Auto Rollback
    environment: test

    steps:
    - name: ğŸ” Login to Azure (for rollback)
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: ğŸ”„ Rollback Backend (if needed)
      if: needs.deploy-backend.result == 'success'
      run: |
        echo "ğŸ”„ Rolling back Test backend..."
        echo "âš ï¸ Automatic rollback implementation needed"
        echo "ğŸ“‹ Manual intervention may be required"

    - name: ğŸ”„ Rollback Frontend (if needed)
      if: needs.deploy-frontend.result == 'success'
      run: |
        echo "ğŸ”„ Rolling back Test frontend..."
        echo "âš ï¸ Static Web Apps rollback requires manual intervention"

name: ğŸ§ª Test Environment CI/CD Pipeline

on:
  push:
    branches: [develop_deploy_pipeline]
  pull_request:
    branches: [develop_deploy_pipeline]
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend to Test'
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy Frontend to Test'
        type: boolean
        default: true
      skip_tests:
        description: 'Skip Tests (Emergency Deploy)'
        type: boolean
        default: false

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ========== í’ˆì§ˆ ê²Œì´íŠ¸ ==========
  quality-gate:
    if: github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    name: ğŸ” Quality Gate

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: backend_py/requirements.txt

    - name: ğŸ”§ Frontend Quality Check
      run: |
        cd frontend
        echo "ğŸ” Installing frontend dependencies..."
        npm ci --legacy-peer-deps || {
          echo "âš ï¸ npm ci failed, falling back to npm install"
          rm -f package-lock.json
          npm install --include=dev
        }
        
        echo "ğŸ” Installing cross-env (Windows/Linux compatibility)..."
        npm install --save-dev cross-env || true
        
        echo "ğŸ” TypeScript check (lenient for Test environment)..."
        npx tsc --noEmit --skipLibCheck --exclude "**/test/**" --exclude "**/*.test.*" || {
          echo "âš ï¸ TypeScript warnings exist but continuing for Test environment"
        }
        
        echo "ğŸ” Build test..."
        rm -rf dist/
        VITE_API_URL=${{ secrets.TEST_BACKEND_URL }} npx vite build --mode test
        
        echo "âœ… Frontend quality check passed"

    - name: ğŸ”§ Backend Quality Check
      run: |
        cd backend_py
        echo "ğŸ” Installing Python dependencies..."
        pip install --no-cache-dir -r requirements.txt
        
        echo "ğŸ” Python syntax check..."
        python -m py_compile app/main.py
        
        echo "ğŸ” FastAPI import test..."
        python -c "from app.main import app; print('âœ… FastAPI app imports successfully')"
        
        echo "âœ… Backend quality check passed"

  # ========== ë°±ì—”ë“œ ë¹Œë“œ & ë°°í¬ ==========
  deploy-backend:
    if: github.event.inputs.deploy_backend != 'false'
    needs: quality-gate
    runs-on: ubuntu-latest
    name: ğŸ Deploy Backend to Test
    environment: test

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Login to Azure
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: ğŸ” Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: ğŸ—ï¸ Build and Push Backend Image
      run: |
        cd backend_py
        echo "ğŸ—ï¸ Building backend Docker image for Test environment..."
        
        # ì•ˆì •ì„± ìš°ì„ : ìºì‹œ ì—†ëŠ” ë¹Œë“œ (Windows â†’ Linux í˜¸í™˜ì„± ë³´ì¥)
        docker build \
          --no-cache \
          --platform linux/amd64 \
          -t ${{ env.REGISTRY }}/backend-fastapi-test:latest \
          -t ${{ env.REGISTRY }}/backend-fastapi-test:${{ github.sha }} \
          -f Dockerfile .
        
        echo "ğŸ“¤ Pushing images to ACR..."
        docker push ${{ env.REGISTRY }}/backend-fastapi-test:latest
        docker push ${{ env.REGISTRY }}/backend-fastapi-test:${{ github.sha }}
        
        echo "âœ… Backend image build and push completed"

    - name: ğŸš€ Deploy to Azure App Service (Test)
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.BACKEND_WEBAPP_NAME }}-test
        images: ${{ env.REGISTRY }}/backend-fastapi-test:latest

    - name: âš™ï¸ Configure Test Environment Variables
      uses: azure/appservice-settings@v1
      with:
        app-name: ${{ secrets.BACKEND_WEBAPP_NAME }}-test
        app-settings-json: |
          [
            { "name": "PORT", "value": "3001" },
            { "name": "HOST", "value": "0.0.0.0" },
            { "name": "NODE_ENV", "value": "test" },
            { "name": "FRONTEND_URL", "value": "${{ secrets.TEST_FRONTEND_URL }}" },
            { "name": "GEMINI_API_KEY", "value": "${{ secrets.TEST_GEMINI_API_KEY }}" },
            { "name": "AZURE_OPENAI_ENDPOINT", "value": "${{ secrets.TEST_AZURE_OPENAI_ENDPOINT }}" },
            { "name": "AZURE_OPENAI_KEY", "value": "${{ secrets.TEST_AZURE_OPENAI_KEY }}" },
            { "name": "AZURE_OPENAI_DEPLOYMENT_ID", "value": "${{ secrets.TEST_AZURE_OPENAI_DEPLOYMENT_ID }}" },
            { "name": "AZURE_OPENAI_API_VERSION", "value": "2024-02-15-preview" }
          ]

  # ========== í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ & ë°°í¬ ==========
  deploy-frontend:
    if: github.event.inputs.deploy_frontend != 'false'
    needs: quality-gate
    runs-on: ubuntu-latest
    name: ğŸ¨ Deploy Frontend to Test
    environment: test

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js with Cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ”§ Install and Build Frontend (Test)
      run: |
        cd frontend
        echo "ğŸ“¦ Installing dependencies with fallback strategy..."
        
        # Windows PowerShell â†’ Linux í˜¸í™˜ì„±ì„ ìœ„í•œ ì„¤ì¹˜ ì „ëµ
        npm ci --legacy-peer-deps || {
          echo "âš ï¸ npm ci failed, using fallback strategy for Windowsâ†’Linux compatibility"
          rm -f package-lock.json
          npm install --include=dev
        }
        
        # cross-env ì„¤ì¹˜ (Windows PowerShell â†’ Linux í™˜ê²½ í˜¸í™˜ì„±)
        echo "ğŸ”§ Installing cross-env for cross-platform compatibility..."
        npm install --save-dev cross-env || true
        
        # TypeScript ê²€ì¦ (Test í™˜ê²½ìš© ê´€ëŒ€í•œ ì„¤ì •)
        echo "ğŸ” TypeScript validation (lenient for Test)..."
        npx tsc --noEmit --skipLibCheck --exclude "**/test/**" --exclude "**/*.test.*" || {
          echo "âš ï¸ TypeScript warnings exist but continuing for Test environment"
        }
        
        # ë¹Œë“œ ì‹¤í–‰ (Test í™˜ê²½ API URL ì£¼ì…)
        echo "ğŸ—ï¸ Building for Test environment..."
        rm -rf dist/
        
        # Linux í™˜ê²½ì—ì„œ ì§ì ‘ Vite ì‹¤í–‰ (cross-env ìš°íšŒ)
        export VITE_API_URL="${{ secrets.TEST_BACKEND_URL }}"
        export VITE_NODE_ENV="test"
        export VITE_DEV_MODE="false"
        
        npx vite build --mode test
        
        # ë¹Œë“œ ê²°ê³¼ ê²€ì¦
        echo "ğŸ“‹ Build verification..."
        ls -la dist/
        echo "âœ… Frontend build completed successfully"

    - name: ğŸš€ Deploy to Azure Static Web Apps (Test)
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "frontend/dist"
        skip_app_build: true
        production_branch: "develop_deploy_pipeline"

  # ========== í—¬ìŠ¤ì²´í¬ & ì•Œë¦¼ ==========
  health-check:
    needs: [deploy-backend, deploy-frontend]
    if: always() && (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')
    runs-on: ubuntu-latest
    name: ğŸ¥ Health Check & Notification

    steps:
    - name: ğŸ¥ Backend Health Check
      if: needs.deploy-backend.result == 'success'
      run: |
        echo "ğŸ” Checking backend health..."
        BACKEND_URL="${{ secrets.TEST_BACKEND_URL }}"
        
        for i in {1..12}; do
          echo "ğŸ“¡ Health check attempt $i/12..."
          
          if curl -f -s --max-time 30 "${BACKEND_URL}/health"; then
            echo "âœ… Backend is healthy!"
            echo "BACKEND_HEALTH=success" >> $GITHUB_ENV
            break
          elif [ $i -eq 12 ]; then
            echo "âŒ Backend health check failed after 12 attempts"
            echo "BACKEND_HEALTH=failed" >> $GITHUB_ENV
            exit 1
          else
            echo "â³ Attempt $i failed, retrying in 30s..."
            sleep 30
          fi
        done

    - name: ğŸ¥ Frontend Health Check
      if: needs.deploy-frontend.result == 'success'
      run: |
        echo "ğŸ” Checking frontend health..."
        FRONTEND_URL="${{ secrets.TEST_FRONTEND_URL }}"
        
        if curl -f -s --max-time 30 "${FRONTEND_URL}"; then
          echo "âœ… Frontend is healthy!"
          echo "FRONTEND_HEALTH=success" >> $GITHUB_ENV
        else
          echo "âŒ Frontend health check failed"
          echo "FRONTEND_HEALTH=failed" >> $GITHUB_ENV
          exit 1
        fi

    - name: ğŸ“Š Test Deployment Summary
      run: |
        echo "## ğŸ§ª Test Environment Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Status | Health | URL |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|---------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend | ${{ needs.deploy-backend.result }} | ${{ env.BACKEND_HEALTH }} | ${{ secrets.TEST_BACKEND_URL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend | ${{ needs.deploy-frontend.result }} | ${{ env.FRONTEND_HEALTH }} | ${{ secrets.TEST_FRONTEND_URL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | ${{ github.sha }} | - | - |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} | - | - |" >> $GITHUB_STEP_SUMMARY
        echo "| Triggered By | ${{ github.actor }} | - | - |" >> $GITHUB_STEP_SUMMARY
        
        echo "ğŸ¯ **Test Environment Ready for Validation!**" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“§ Success Notification (Placeholder)
      if: success()
      run: |
        echo "ğŸ‰ Test deployment successful!"
        echo "ğŸ“§ TODO: Configure Teams/Discord/Email notification"
        echo "Backend: ${{ secrets.TEST_BACKEND_URL }}/health"
        echo "Frontend: ${{ secrets.TEST_FRONTEND_URL }}"

    - name: ğŸš¨ Failure Notification (Placeholder)
      if: failure()
      run: |
        echo "ğŸ’¥ Test deployment failed!"
        echo "ğŸ“§ TODO: Configure Teams/Discord/Email notification"
        echo "Check the logs above for details"
        exit 1

  # ========== ìë™ ë¡¤ë°± (í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‹œ) ==========
  auto-rollback:
    needs: health-check
    if: failure()
    runs-on: ubuntu-latest
    name: ğŸ”„ Auto Rollback
    environment: test

    steps:
    - name: ğŸ” Login to Azure (for rollback)
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: ğŸ”„ Rollback Backend (if needed)
      if: needs.deploy-backend.result == 'success'
      run: |
        echo "ğŸ”„ Rolling back backend to previous version..."
        # TODO: Azure App Service ìŠ¬ë¡¯ ìŠ¤ì™‘ ë˜ëŠ” ì´ì „ ì´ë¯¸ì§€ë¡œ ë¡¤ë°±
        echo "ğŸš¨ Manual intervention required for backend rollback"

    - name: ğŸ”„ Rollback Frontend (if needed)
      if: needs.deploy-frontend.result == 'success'
      run: |
        echo "ğŸ”„ Rolling back frontend to previous version..."
        # TODO: Static Web Apps ì´ì „ ë°°í¬ë¡œ ë¡¤ë°±
        echo "ğŸš¨ Manual intervention required for frontend rollback"

    - name: ğŸ“§ Rollback Notification
      run: |
        echo "ğŸ”„ Auto rollback initiated due to health check failure"
        echo "ğŸ“§ TODO: Send urgent notification to team"
        echo "Manual verification and intervention may be required"

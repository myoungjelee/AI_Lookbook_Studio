name: ğŸ§ª Test Environment CI/CD Pipeline

on:
  push:
    branches: [develop_deploy_pipeline]
  pull_request:
    branches: [develop_deploy_pipeline]
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend to Test'
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy Frontend to Test'
        type: boolean
        default: true
      skip_tests:
        description: 'Skip Tests (Emergency Deploy)'
        type: boolean
        default: false
      debug_mode:
        description: 'Enable Debug Logging'
        type: boolean
        default: true  # ê¸°ë³¸ê°’ì„ trueë¡œ ë³€ê²½

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  # í•˜ë“œì½”ë”©ëœ Azure ë¦¬ì†ŒìŠ¤ ì •ë³´
  BACKEND_APP_NAME_TEST: "7ai-team1-backend-test"
  AZURE_RESOURCE_GROUP_HARDCODED: "7ai-final-team1"

jobs:
  # ========== í’ˆì§ˆ ê²Œì´íŠ¸ ==========
  quality-gate:
    if: github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    name: ğŸ” Quality Gate

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ Setup Python (No Pip Cache)
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ”§ Frontend Quality Check
      run: |
        cd frontend
        echo "ğŸ” Installing frontend dependencies..."
        npm ci --legacy-peer-deps || {
          echo "âš ï¸ npm ci failed, falling back to npm install"
          rm -f package-lock.json
          npm install --include=dev
        }
        
        echo "ğŸ” Installing cross-env (Windows/Linux compatibility)..."
        npm install --save-dev cross-env || true
        
        echo "ğŸ” TypeScript check (lenient for Test environment)..."
        npx tsc --noEmit --skipLibCheck --exclude "**/test/**" --exclude "**/*.test.*" || {
          echo "âš ï¸ TypeScript warnings exist but continuing for Test environment"
        }
        
        echo "ğŸ” Build test..."
        rm -rf dist/
        VITE_API_URL=${{ secrets.TEST_BACKEND_URL }} npx vite build --mode test
        
        echo "âœ… Frontend quality check passed"

    - name: ğŸ”§ Backend Quality Check
      run: |
        cd backend_py
        echo "ğŸ” Installing Python dependencies (no cache)..."
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        
        echo "ğŸ” Python syntax check..."
        python -m py_compile app/main.py
        
        echo "ğŸ” FastAPI import test..."
        python -c "from app.main import app; print('âœ… FastAPI app imports successfully')"
        
        echo "âœ… Backend quality check passed"

  # ========== ë°±ì—”ë“œ ë¹Œë“œ & ë°°í¬ ==========
  deploy-backend:
    if: github.event.inputs.deploy_backend != 'false'
    needs: quality-gate
    runs-on: ubuntu-latest
    name: ğŸ Deploy Backend to Test
    environment: test

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Full Debug Information
      run: |
        echo "=================== FULL DEBUG INFO ==================="
        echo "ğŸ” Hardcoded App Service: ${{ env.BACKEND_APP_NAME_TEST }}"
        echo "ğŸ” Hardcoded Resource Group: ${{ env.AZURE_RESOURCE_GROUP_HARDCODED }}"
        echo "ğŸ” Secret Resource Group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
        echo "ğŸ” Secret Backend Name: ${{ secrets.BACKEND_WEBAPP_NAME }}"
        echo "ğŸ” Registry: ${{ env.REGISTRY }}"
        echo "======================================================"

    - name: ğŸ” Login to Azure
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: ğŸ” Comprehensive Azure Resource Check
      run: |
        echo "ğŸ” Current Azure account info:"
        az account show --query "{SubscriptionId:id, SubscriptionName:name, TenantId:tenantId, User:user.name}" -o table
        
        echo ""
        echo "ğŸ” Checking subscription access:"
        az account list --query "[].{Name:name, SubscriptionId:id, State:state}" -o table
        
        echo ""
        echo "ğŸ” Checking Resource Groups in current subscription:"
        az group list --query "[].{Name:name, Location:location}" -o table
        
        echo ""
        echo "ğŸ” Checking if hardcoded resource group exists:"
        az group show --name "${{ env.AZURE_RESOURCE_GROUP_HARDCODED }}" --query "{Name:name, Location:location, ProvisioningState:properties.provisioningState}" -o table || {
          echo "âŒ Hardcoded resource group '${{ env.AZURE_RESOURCE_GROUP_HARDCODED }}' not found!"
        }
        
        echo ""
        echo "ğŸ” Checking if secret resource group exists:"
        az group show --name "${{ secrets.AZURE_RESOURCE_GROUP }}" --query "{Name:name, Location:location, ProvisioningState:properties.provisioningState}" -o table || {
          echo "âŒ Secret resource group '${{ secrets.AZURE_RESOURCE_GROUP }}' not found!"
        }
        
        echo ""
        echo "ğŸ” All App Services in hardcoded resource group:"
        az webapp list --resource-group "${{ env.AZURE_RESOURCE_GROUP_HARDCODED }}" --query "[].{Name:name, State:state, Location:location, Kind:kind}" -o table || {
          echo "âŒ Cannot list App Services in hardcoded resource group"
        }
        
        echo ""
        echo "ğŸ” All App Services in secret resource group:"
        az webapp list --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" --query "[].{Name:name, State:state, Location:location, Kind:kind}" -o table || {
          echo "âŒ Cannot list App Services in secret resource group"
        }
        
        echo ""
        echo "ğŸ” Specifically checking for our target App Service (hardcoded RG):"
        az webapp show --name "${{ env.BACKEND_APP_NAME_TEST }}" --resource-group "${{ env.AZURE_RESOURCE_GROUP_HARDCODED }}" --query "{Name:name, State:state, Location:location, Kind:kind, DefaultHostName:defaultHostName}" -o table || {
          echo "âŒ App Service '${{ env.BACKEND_APP_NAME_TEST }}' not found in hardcoded resource group '${{ env.AZURE_RESOURCE_GROUP_HARDCODED }}'"
        }
        
        echo ""
        echo "ğŸ” Specifically checking for our target App Service (secret RG):"
        az webapp show --name "${{ env.BACKEND_APP_NAME_TEST }}" --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" --query "{Name:name, State:state, Location:location, Kind:kind, DefaultHostName:defaultHostName}" -o table || {
          echo "âŒ App Service '${{ env.BACKEND_APP_NAME_TEST }}' not found in secret resource group '${{ secrets.AZURE_RESOURCE_GROUP }}'"
        }

    - name: ğŸ” Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: ğŸ—ï¸ Build and Push Backend Image
      run: |
        cd backend_py
        echo "ğŸ—ï¸ Building backend Docker image for Test environment..."
        
        # ì•ˆì •ì„± ìš°ì„ : ìºì‹œ ì—†ëŠ” ë¹Œë“œ
        docker build \
          --no-cache \
          --platform linux/amd64 \
          -t ${{ env.REGISTRY }}/backend-fastapi-test:latest \
          -t ${{ env.REGISTRY }}/backend-fastapi-test:${{ github.sha }} \
          -f Dockerfile .
        
        echo "ğŸ“¤ Pushing images to ACR..."
        docker push ${{ env.REGISTRY }}/backend-fastapi-test:latest
        docker push ${{ env.REGISTRY }}/backend-fastapi-test:${{ github.sha }}
        
        echo "âœ… Backend image build and push completed"

    - name: ğŸš€ Deploy to Azure App Service (Test - Both Resource Groups)
      run: |
        echo "ğŸš€ Attempting deployment with hardcoded resource group..."
        
        # ë°©ë²• 1: í•˜ë“œì½”ë”©ëœ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ì‚¬ìš©
        az webapp deploy --name "${{ env.BACKEND_APP_NAME_TEST }}" \
                        --resource-group "${{ env.AZURE_RESOURCE_GROUP_HARDCODED }}" \
                        --type container \
                        --image "${{ env.REGISTRY }}/backend-fastapi-test:latest" || {
          echo "âŒ Deployment with hardcoded resource group failed"
          
          echo "ğŸš€ Attempting deployment with secret resource group..."
          # ë°©ë²• 2: Secret ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ì‚¬ìš©
          az webapp deploy --name "${{ env.BACKEND_APP_NAME_TEST }}" \
                          --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
                          --type container \
                          --image "${{ env.REGISTRY }}/backend-fastapi-test:latest" || {
            echo "âŒ Deployment with secret resource group also failed"
            
            # ë°©ë²• 3: azure/webapps-deploy ì•¡ì…˜ ì‚¬ìš© (ì›ë˜ ë°©ë²•)
            echo "ğŸš€ Falling back to webapps-deploy action..."
            echo "::set-output name=use_action::true"
          }
        }

    - name: ğŸš€ Deploy to Azure App Service (Fallback Action)
      if: steps.deploy.outputs.use_action == 'true'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.BACKEND_APP_NAME_TEST }}
        resource-group-name: ${{ env.AZURE_RESOURCE_GROUP_HARDCODED }}  # ëª…ì‹œì ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ì§€ì •
        images: ${{ env.REGISTRY }}/backend-fastapi-test:latest

    - name: âš™ï¸ Configure Test Environment Variables (Multiple Attempts)
      run: |
        echo "âš™ï¸ Configuring environment variables..."
        
        # í•˜ë“œì½”ë”©ëœ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ìœ¼ë¡œ ì‹œë„
        az webapp config appsettings set \
          --name "${{ env.BACKEND_APP_NAME_TEST }}" \
          --resource-group "${{ env.AZURE_RESOURCE_GROUP_HARDCODED }}" \
          --settings \
            PORT=3001 \
            HOST=0.0.0.0 \
            NODE_ENV=test \
            FRONTEND_URL="${{ secrets.TEST_FRONTEND_URL }}" \
            GEMINI_API_KEY="${{ secrets.TEST_GEMINI_API_KEY }}" \
            AZURE_OPENAI_ENDPOINT="${{ secrets.TEST_AZURE_OPENAI_ENDPOINT }}" \
            AZURE_OPENAI_KEY="${{ secrets.TEST_AZURE_OPENAI_KEY }}" \
            AZURE_OPENAI_DEPLOYMENT_ID="${{ secrets.TEST_AZURE_OPENAI_DEPLOYMENT_ID }}" \
            AZURE_OPENAI_API_VERSION="2024-02-15-preview" || {
          
          echo "âš ï¸ Failed with hardcoded resource group, trying secret resource group..."
          
          # Secret ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ìœ¼ë¡œ ì‹œë„
          az webapp config appsettings set \
            --name "${{ env.BACKEND_APP_NAME_TEST }}" \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --settings \
              PORT=3001 \
              HOST=0.0.0.0 \
              NODE_ENV=test \
              FRONTEND_URL="${{ secrets.TEST_FRONTEND_URL }}" \
              GEMINI_API_KEY="${{ secrets.TEST_GEMINI_API_KEY }}" \
              AZURE_OPENAI_ENDPOINT="${{ secrets.TEST_AZURE_OPENAI_ENDPOINT }}" \
              AZURE_OPENAI_KEY="${{ secrets.TEST_AZURE_OPENAI_KEY }}" \
              AZURE_OPENAI_DEPLOYMENT_ID="${{ secrets.TEST_AZURE_OPENAI_DEPLOYMENT_ID }}" \
              AZURE_OPENAI_API_VERSION="2024-02-15-preview"
        }

  # ë‚˜ë¨¸ì§€ jobsëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€...
  deploy-frontend:
    if: github.event.inputs.deploy_frontend != 'false'
    needs: quality-gate
    runs-on: ubuntu-latest
    name: ğŸ¨ Deploy Frontend to Test
    environment: test

    steps:
    - name: ğŸ“¦ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js with Cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ”§ Install and Build Frontend (Test)
      run: |
        cd frontend
        npm ci --legacy-peer-deps || {
          rm -f package-lock.json
          npm install --include=dev
        }
        npm install --save-dev cross-env || true
        npx tsc --noEmit --skipLibCheck --exclude "**/test/**" --exclude "**/*.test.*" || true
        rm -rf dist/
        export VITE_API_URL="${{ secrets.TEST_BACKEND_URL }}"
        export VITE_NODE_ENV="test"
        export VITE_DEV_MODE="false"
        npx vite build --mode test
        ls -la dist/

    - name: ğŸš€ Deploy to Azure Static Web Apps (Test)
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "frontend/dist"
        skip_app_build: true
        production_branch: "develop_deploy_pipeline"

  # í—¬ìŠ¤ì²´í¬ëŠ” ê°„ì†Œí™”
  health-check:
    needs: [deploy-backend, deploy-frontend]
    if: always() && (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')
    runs-on: ubuntu-latest
    name: ğŸ¥ Health Check

    steps:
    - name: ğŸ¥ Basic Health Check
      run: |
        echo "ğŸ” Checking services..."
        if [[ "${{ needs.deploy-backend.result }}" == "success" ]]; then
          curl -f -s --max-time 30 "${{ secrets.TEST_BACKEND_URL }}/health" && echo "âœ… Backend healthy" || echo "âŒ Backend unhealthy"
        fi
        if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
          curl -f -s --max-time 30 "${{ secrets.TEST_FRONTEND_URL }}" && echo "âœ… Frontend healthy" || echo "âŒ Frontend unhealthy"
        fi
